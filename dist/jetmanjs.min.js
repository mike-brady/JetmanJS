class Game{constructor(c,d){this.debugMode=!1,this.canvas=c,this.ctx=this.canvas.getContext('2d'),this.jetman=d,this.columnWidth=1,this.defaultGapHeight=this.canvas.height/1.5,this.minGapHeight=5*this.jetman.height,this.minWallHeight=20,this.slope=0,this.maxSlope=.5,this.slopeChangeRate=200/this.columnWidth,this.slopeChangeRateSD=150/this.columnWidth,this.nextSlopeChange=this.slopeChangeRate,this.columns=[],this.barriers=[],this.nextBarrier=1.25*this.canvas.width,this.paused=!0,this.gameOver=!1,this.stepper,this.frameRate=60,this.speed=4,this.mousedown=!1,this.globalMousedown=!1,this.fallRate=3,this.dist=0,this.score=0,this.highScore=0}init(){this.debugMode&&console.log('DEBUG MODE ON'),localStorage.jetmanHS&&(this.highScore=localStorage.jetmanHS),this.reset();var c=this;document.addEventListener('mousedown',function(){c.globalMousedown=!0},!0),document.addEventListener('mouseup',function(){c.globalMousedown=!1},!0),this.debugMode&&document.addEventListener('keyup',function(d){32==d.keyCode&&c.playPause()},!0),this.canvas.addEventListener('mousedown',function(){c.mousedown=!0,c.gameOver||(c.paused=!1)},!1),this.canvas.addEventListener('touchstart',function(){c.mousedown=!0,c.gameOver||(c.paused=!1)},!1),this.canvas.addEventListener('mouseup',function(){c.mousedown=!1},!1),this.canvas.addEventListener('touchend',function(){c.mousedown=!1},!1),this.canvas.addEventListener('touchcancel',function(){c.mousedown=!1},!1),this.canvas.addEventListener('mouseout',function(){c.mousedown=!1},!0),this.canvas.addEventListener('mouseenter',function(){c.globalMousedown&&(c.mousedown=!0)},!0);var c=this;this.stepper=setInterval(function(){c.step(),c.draw()},1e3/c.frameRate)}playPause(){this.paused=!this.paused}setNextSlopeChange(){var c=this.nextSlopeChange+this.slopeChangeRate,d=Math.floor(Math.random()*this.slopeChangeRateSD);.5>Math.random()?c+=d:c-=d,this.nextSlopeChange=c}setSlope(){var c=Math.random(),d=this.columns[this.columns.length-1];c*=d.top==this.minWallHeight||d.bottom==this.canvas.height-this.minWallHeight?2:3,1>c?this.slope=0:(this.slope=-1*(Math.random()*this.maxSlope),(d.top==this.minWallHeight||2<c)&&(this.slope*=-1))}removeColumns(){for(;0>=this.columns[0].right;)this.columns.shift()}addColumns(){for(;0==this.columns.length||this.columns[this.columns.length-1].left<=this.canvas.width;){var c=this.columnWidth/2,d=this.canvas.height/2,f=this.defaultGapHeight;if(0<this.columns.length){var g=this.columns[this.columns.length-1];c=g.right,d=Math.min(this.canvas.height-this.minWallHeight-f/2,Math.max(this.minWallHeight+f/2,this.columns[this.columns.length-1].y+this.slope*this.columnWidth))}this.columns.push(new Object(c,d,this.columnWidth,f))}}addBarrier(c,d,f,g){this.barriers.push(new Object(c,d,f,g))}step(){if(!this.paused){var c=this.speed;for(var d in this.columns){var f=this.columns[d].getXY();this.columns[d].setXY(f.x-c,f.y)}for(var d in this.barriers){var f=this.barriers[d].getXY();this.barriers[d].setXY(f.x-c,f.y)}var f=this.jetman.getXY(),g=f;this.mousedown?(g.y=f.y-this.jetman.riseRate,this.jetman.setXY(g.x,g.y)):(g.y=f.y+this.fallRate,this.jetman.setXY(g.x,g.y)),this.crashed()?this.endGame():(this.dist+=c,this.score=Math.round(this.dist/100)),this.nextSlopeChange--,this.nextBarrier-=c,this.columns.length>this.nextSlopeChange&&(this.setSlope(),this.setNextSlopeChange()),this.nextBarrier<this.dist+this.canvas.width/2&&(this.addBarrier(this.canvas.width,this.canvas.height/2-30,20,60),console.log('TODO: Fix this. Not static ints.'),this.nextBarrier=this.dist+2*this.canvas.width),this.removeColumns(),this.addColumns()}}endGame(){this.gameOver=!0,this.paused=!0,this.score>this.highScore&&(localStorage.jetmanHS=this.score,this.highScore=this.score);var c=this;setTimeout(function(){c.reset()},500)}draw(){for(var c in this.ctx.fillStyle='#3333ff',this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle='#000000',this.columns)this.debugMode&&(this.ctx.fillStyle='#000000'),this.ctx.fillRect(this.columns[c].left,this.columns[c].top,this.columns[c].width,this.columns[c].height),this.debugMode&&(this.ctx.fillStyle='#ff0000',this.ctx.fillRect(this.columns[c].x,this.columns[c].y,1,1));for(var c in this.barriers)this.ctx.fillStyle='#3333ff',this.ctx.fillRect(this.barriers[c].left,this.barriers[c].top,this.barriers[c].width,this.barriers[c].height);this.ctx.drawImage(this.jetman.sprite,this.jetman.left,this.jetman.top,this.jetman.width,this.jetman.height),this.debugMode&&(this.ctx.strokeStyle='#888822',this.ctx.strokeRect(this.jetman.x-this.jetman.width/2,this.jetman.y-this.jetman.height/2,this.jetman.width,this.jetman.height)),this.ctx.font='24px Arial',this.ctx.fillStyle='#ffffff',this.ctx.textAlign='left',this.ctx.fillText('High Score: '+this.highScore+' Score: '+this.score,10,28),0==this.score&&this.paused&&(this.ctx.font='24px Arial',this.ctx.fillStyle='#ffffff',this.ctx.textAlign='center',this.ctx.fillText('Click to Start',this.canvas.width/2,this.canvas.height/2+60))}crashed(){for(var c in this.columns)if(this.xCollision(this.jetman,this.columns[c])&&this.yOutOfBounds(this.jetman,this.columns[c]))return!0;for(var c in this.barriers)if(this.collision(this.jetman,this.barriers[c]))return!0;return!1}collision(c,d){return this.xCollision(c,d)&&this.yCollision(c,d)}xCollision(c,d){return c.left<=d.right&&c.right>=d.left}yCollision(c,d){return c.top<=d.bottom&&c.bottom>=d.top}xOutOfBounds(c,d){return c.left<=d.left||c.right>=d.right}yOutOfBounds(c,d){return c.top<=d.top||c.bottom>=d.bottom}reset(){this.columns=[],this.barriers=[],this.slope=0,this.dist=0,this.score=0,this.addColumns(),this.jetman.setXY(this.canvas.width/2,this.canvas.height/2),this.draw(),this.paused=!0,this.gameOver=!1}}class Jetman extends Object{constructor(c,d,f){super(c,d,0,0),this.riseRate=2.25,this.sprite=new Image,this.sprite.src=f;var g=this;this.sprite.onload=function(){g.width=this.width,g.height=this.height,g.setBounds()}}}window.onload=function(){var c=document.getElementById('jetman'),d=new Game(c,new Jetman(c.width/2,c.height/2,'sprites/jetman.png'));d.init()};class Object{constructor(c,d,f,g){this.x=c,this.y=d,this.width=f,this.height=g,this.setBounds()}setXY(c,d){this.x=c,this.y=d,this.setBounds()}getXY(){return{x:this.x,y:this.y}}setBounds(){this.left=this.x-this.width/2,this.top=this.y-this.height/2,this.right=this.x+this.width/2,this.bottom=this.y+this.height/2}}
